# 例子1：采集Modbus仿真数据

ThingsLink网关作为物联网平台的数据入口，采集目标设备和系统的数据是最基础核心的功能，下面的步骤以采集一个Modbus仿真设备为例，介绍一下如何通过平台为远程的ThingsLink网关安装应用采集目标设备数据的完整过程。

这里我使用Modbus仿真软件Modsim搭配1个配置文件模拟某个设备。Modbus仿真软件的下载和安装使用请参考[“设备/模拟器”]一节。

ThingRoot平台中，针对设备的数据采集应用多是一对一的对应关系。因此，使用应用采集目标设备数据时，需要先知道目标设备的厂商、型号等信息，然后再去应用商店中按照厂商，型号等过滤条件去查找对应的应用程序，找到应用程序可能不存在（针对此设备的应用未开发）或多个（多个开发者开发了针对此设备的应用）。找不到目标设备对应的应用时，需要自己开发针对目标设备的应用（需要用户掌握ThingsLink应用开发的相关知识），或者委托平台厂商或第三方开发者开发目标设备的应用。

对于一些采用了行业标准协议的设备，平台也提供了一部分适配行业标准协议的通用性应用，这类应用可让用户通过配置面板对应用的参数进行增删改查，还可对设备的IO采集标签及标签参数进行修改。下面以Modbus通用型应用General_Modbus为例来描述一下如何采集一个Modbus仿真器的数据（Modbus仿真器的设备地址，功能码，数据地址及类型等参数非固定）。


步骤如下：

1) 启动Modsim32软件。创建虚拟Modbus设备，这里我创建了3个配置页，采用MobusTC协议，运行在502端口。
   配置页1：【设备地址1，03功能码，起始地址1，8个寄存器，4个浮点数】；
   配置页2：【设备地址2，04功能码，起始地址101，10个寄存器，10个整数】；
   配置页3：【设备地址3，01功能码，起始地址201，10个寄存器，10个开关量】
   如下图所示：

![](../assets/Clip_20190109_121426.png)

2) 在应用安装页面在通过名称过滤等方式找到General_Modbus应用，如下图所示：
![](..\v1\part-ii\ThingsCloud_2019-06-24_12-28-16.png)


3) 点击安装到网关图标，在新的界面在输入网关中的应用实例名，设置应用的各个参数，本例中使用Mobbus tcp协议和仿真设备通讯，因此通讯协议选“tcp”，链路类型选“socket”，如下图所示：
![](..\v1\part-ii\ThingsCloud_2019-06-24_12-29-03.png)


4) 接下来，是添加设备模板和设备。下面通过设备模板中的“创建新模板”按钮增加设备模板。如下图所示：
![](..\v1\part-ii\ThingsCloud_2019-06-24_12-30-05.png)


5) 也可使用自己已经创建好的模板，直接选择合适的模板即可，本例选择模板test2.
![](..\v1\part-ii\ThingsCloud_2019-06-24_12-31-28.png)

6) 在模板选择中，可以直接查看现在的模板是否符合要求，如不符合且模板所有者为当前用户，则可以使用新的模板文件（csv格式）升级.
![](..\v1\part-ii\ThingsCloud_2019-06-24_12-31-34.png)

7) 模板添加完成（可以选择多个模板）后，就可以添加设备了，本例中ModbusTCP设备地址为1，设备模板为上面的test2，设备名称，设备描述根据情况自己定义。此处需要强调的是设备序列号在当前应用下必须唯一，不能多个设备使用相同的设备序号。最后点击下方的提交按钮，即可将此应用安装到目标网关中。
![](..\v1\part-ii\ThingsCloud_2019-06-24_12-33-40.png)

8) 根据应用的大写不一样，安装等待的时间大概是几秒到几十秒左右，页面会反馈安装的结果，如安装成功，则会出现如下提示。
![](..\v1\part-ii\ThingsCloud_2019-06-24_13-02-03.png)

9) 如安装失败，则会提示失败原因。

10) 返回应用列表，就可以看见刚刚安装的应用General_Modbus（本地实例名modsim1）已经安装在此网关并运行起来了。点击应用，在下方会出现应用的信息及操作按钮。
![](..\v1\part-ii\ThingsCloud_2019-06-24_13-04-01.png)

11) 切换到设备列表，查看通过应用modsim1采集的ModbusTCP设备是否采集到数据，展开dev1设备，发现标签名称都存在，但数值全部为空。
![](..\v1\part-ii\ThingsCloud_2019-06-24_13-04-25.png)

12) 出现此问题大概有2个方面的问题，一种情况是应用无法和目标设备通讯，不能正确获取到数据；另一种情况是此网关默认并不向ThingsCloud平台推送数据，这种情况下，点击右上角的“开启临时数据上传”按钮即可。
![](..\v1\part-ii\ThingsCloud_2019-06-24_13-04-25.png)
    如网关未开启向ThingsCloud平台推送数据，在页面的左上角会有图标提示，第一个图标是网关在线状态的图标，第2个图标就是网关是否开启数据上送的图标（当前是未开启）。
![](..\v1\part-ii\ThingsCloud_2019-06-24_13-04-47.png)

13) 如果设备还是没有数据，我们需要切换到网关日志页面下，去查看应用modsim1的日志，看一看未采集到数据的原因。
![](..\v1\part-ii\ThingsCloud_2019-06-24_13-07-59.png)

14) 在搜索框在输入modsim1，对日志进行过滤，可以看到应用提示，要采集的目标设备不能连接。从这里可以判断出问题在和目标设备无法通讯。
![](..\v1\part-ii\ThingsCloud_2019-06-24_13-08-17.png)

15) 将网关和目标设备的通讯故障解决后（可能是链路故障，路由故障等原因），就可以在设备列表中看到目标设备的实时数据了。
![](..\v1\part-ii\ThingsCloud_2019-06-24_13-16-08.png)

